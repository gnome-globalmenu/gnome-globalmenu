Index: gtk+-aqd/gtk/gtkmenubar.c
===================================================================
--- gtk+-aqd/gtk/gtkmenubar.c	(revision 19601)
+++ gtk+-aqd/gtk/gtkmenubar.c	(working copy)
@@ -85,11 +85,55 @@
 
 static GtkShadowType get_shadow_type   (GtkMenuBar      *menubar);
 
+gpointer _libgnomenu_lookup(gchar * name){
+	gpointer sym = NULL;
+	static gboolean loaded = FALSE;
+	static GModule * libgnomenu = NULL;
+	static gint * version = NULL;
+	if(!loaded) {
+		libgnomenu = g_module_open("libgnomenu", 0 /*G_MODULE_BIND_LOCAL*/);
+		if(!libgnomenu)
+			g_warning("Global Menu Library(libgnomenu) not found. "
+					"Fall back to GTK code for handling menu bar. "
+					"GTK-aqd is intended to provide Global Menu"
+					"support from legacy GTK applications. "
+					);
+		loaded = TRUE;
+		if(libgnomenu) 
+			if(!g_module_symbol(libgnomenu,
+				"gnomenu_version", 
+				&version) || *version != 4){
+				libgnomenu = NULL;
+			g_warning("Global Menu Library(libgnomenu) found, "
+					"but the version doesn't match. "
+					"This patch works with libgnomenu == 0.4");
+		}
+	}
+	if(libgnomenu) {
+		if(!g_module_symbol(libgnomenu, 
+				name, 
+				&sym)){
+			g_warning("Symbol %s is supposed to be in libgnomenu, "
+					"but it is not found. "
+					"You are potentially using an incompatible libgnomenu. "
+					"Fall back to GTK code for menu bar/ or core dump later. ", 
+					name);
+			sym = NULL;
+		};
+		
+	}
+	return sym;
+}
+
 G_DEFINE_TYPE (GtkMenuBar, gtk_menu_bar, GTK_TYPE_MENU_SHELL)
 
 static void
 gtk_menu_bar_class_init (GtkMenuBarClass *class)
 {
+  gboolean * compatible = _libgnomenu_lookup("gnomenu_compatible");
+  void (*gnomenu_menu_bar_class_init)(gpointer klass)
+			= _libgnomenu_lookup("gnomenu_menu_bar_class_intern_init");
+
   GObjectClass *gobject_class;
   GtkWidgetClass *widget_class;
   GtkMenuShellClass *menu_shell_class;
@@ -214,12 +258,25 @@
 						   0,
 						   GTK_PARAM_READWRITE));
 
+	if(compatible && * compatible && gnomenu_menu_bar_class_init) {
+		g_message("Using Global Menu");
+		(*gnomenu_menu_bar_class_init)(class);
+	} else 
+
   g_type_class_add_private (gobject_class, sizeof (GtkMenuBarPrivate));  
 }
 
 static void
 gtk_menu_bar_init (GtkMenuBar *object)
 {
+  gboolean * compatible = _libgnomenu_lookup("gnomenu_compatible");
+  void (*gnomenu_menu_bar_init)(gpointer obj)
+			= _libgnomenu_lookup("gnomenu_menu_bar_init");
+
+	if(compatible && * compatible && gnomenu_menu_bar_init) {
+		(*gnomenu_menu_bar_init)(object);
+		return;
+	}
 }
 
 GtkWidget*
